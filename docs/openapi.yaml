openapi: 3.0.3
info:
  title: RP Management API
  description: |
    RPサイト向けユーザー情報管理API

    このAPIは、複数のRP（Relying Party）サイトの会員情報をIdPで統合管理するためのものです。
    RPサーバーからサーバー間通信でユーザー情報を取得できます。

    ## 認証
    すべてのエンドポイントでBasic認証（client_id/client_secret）が必要です。

    ## セキュリティ
    - HTTPS必須
    - サーバー間通信のみ
    - IP制限あり
    - ブラウザからのアクセス不可（CORS制限）
  version: 1.0.0
  contact:
    name: IdP API Support
  license:
    name: Proprietary

security:
  - basicAuth: []

tags:
  - name: users
    description: ユーザー情報管理

paths:
  /users/{id}:
    get:
      summary: ユーザーID指定取得
      description: 指定したユーザーIDの情報を取得します。
      operationId: getUserById
      tags:
        - users
      parameters:
        - name: id
          in: path
          description: ユーザーID
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          example: 123
      responses:
        '200':
          description: 成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
              examples:
                success:
                  summary: ユーザー情報取得成功
                  value:
                    id: 123
                    email: user@example.com
                    last_name: 佐藤
                    first_name: 桜子
                    last_kana_name: さとう
                    first_kana_name: さくらこ
                    has_middle_name: 0
                    middle_name: null
                    birth_date: "1990-01-01"
                    gender_code: 1
                    gender_text: null
                    home_is_address_selected_manually: 0
                    home_postal_code: "1500001"
                    home_prefecture_code: 13
                    home_master_city_id: 1001
                    home_address_town: 神宮前
                    home_address_later: 1-2-3 あずかるコーポ101
                    home_latitude: 35.6762
                    home_longitude: 139.6503
                    profile_image_data: null
                    phone_number: "09012345678"
                    employment_status: 1
                    workplace_name: あずかる株式会社
                    workplace_phone_number: "0312345678"
                    workplace_is_address_selected_manually: 0
                    workplace_postal_code: "1000001"
                    workplace_prefecture_code: 13
                    workplace_master_city_id: 1002
                    workplace_address_town: 千代田
                    workplace_address_later: 1-1-1 ビル5F
                    last_sign_in_at: "2025-01-15T10:30:00Z"
                    created_at: "2025-01-01T00:00:00Z"
                    updated_at: "2025-01-15T12:00:00Z"
                    metadata:
                      custom_id: "RP-A-123"
                      tags: ["premium"]
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

    patch:
      summary: ユーザー情報部分更新
      description: |
        指定したユーザーIDの情報を部分更新します。

        送信されたフィールドのみ更新され、他のフィールドは変更されません。

        **動作:**
        - ID不在 → 404 Not Found
        - 成功 → 200 OK
        - updated_by にリクエスト元RPのIDを設定
      operationId: updateUserPartial
      tags:
        - users
      parameters:
        - name: id
          in: path
          description: ユーザーID
          required: true
          schema:
            type: integer
            format: int64
            minimum: 1
          example: 123
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserUpdateRequest'
            examples:
              partialUpdate:
                summary: 部分更新例（電話番号とmetadataのみ）
                value:
                  phone_number: "09087654321"
                  metadata:
                    custom_id: "RP-A-999"
                    tags: ["vip"]
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/ValidationError'

  /users:
    get:
      summary: ユーザー検索
      description: |
        複数の検索条件でユーザー情報を取得します。

        **レスポンスは常に配列形式です**。
        - `ids`: 0〜N件の配列
        - `name`: 0〜N件の配列（部分一致）
        - `kana_name`: 0〜N件の配列（部分一致）
        - `phone_number`: 0〜1件の配列（完全一致）
      operationId: searchUsers
      tags:
        - users
      parameters:
        - name: ids
          in: query
          description: ユーザーIDのカンマ区切りリスト
          required: false
          schema:
            type: string
            pattern: '^[0-9]+(,[0-9]+)*$'
          example: "1,2,3"
        - name: name
          in: query
          description: 氏名（漢字）部分一致検索
          required: false
          schema:
            type: string
          example: "佐藤"
        - name: kana_name
          in: query
          description: 氏名（かな）部分一致検索
          required: false
          schema:
            type: string
          example: "さとう"
        - name: phone_number
          in: query
          description: 電話番号（完全一致、ハイフンあり・なし両方対応）
          required: false
          schema:
            type: string
          example: "09012345678"
        - name: limit
          in: query
          description: 取得件数（デフォルト: 100、最大: 1000）
          required: false
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
          example: 100
        - name: offset
          in: query
          description: 開始位置（デフォルト: 0）
          required: false
          schema:
            type: integer
            default: 0
            minimum: 0
          example: 0
        - name: registered_only
          in: query
          description: |
            自RPに登録されているユーザーのみを検索対象とします（推奨）。
            未指定の場合、全ユーザーが検索対象となります。
          required: false
          schema:
            type: string
            enum: ['true', 'false']
          example: "true"
        - name: activated_only
          in: query
          description: |
            自RPに登録済みかつSSOログイン済み（activated_at が設定済み）のユーザーのみを検索対象とします。
            このパラメータを指定した場合、registered_only は暗黙的に true として扱われます。
          required: false
          schema:
            type: string
            enum: ['true', 'false']
          example: "true"
      responses:
        '200':
          description: 成功（常に配列形式）
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
              examples:
                nameSearch:
                  summary: 氏名（漢字）検索（配列で複数件）
                  value:
                    - id: 123
                      email: user@example.com
                      last_name: 山田
                      first_name: 裕美
                      last_kana_name: やまだ
                      first_kana_name: ひろみ
                      birth_date: "1990-01-01"
                      phone_number: "09012345678"
                kanaNameSearch:
                  summary: 氏名（かな）検索（配列で複数件）
                  value:
                    - id: 456
                      email: user2@example.com
                      last_name: 佐藤
                      first_name: 桜子
                      last_kana_name: さとう
                      first_kana_name: さくらこ
                phoneSearch:
                  summary: 電話番号検索（配列で1件）
                  value:
                    - id: 789
                      email: user3@example.com
                      last_name: 鈴木
                      first_name: 花子
                      phone_number: "09087654321"
                notFound:
                  summary: 該当なし
                  value: []
                idsSearch:
                  summary: 複数ID検索（配列で複数件）
                  value:
                    - id: 1
                      email: user1@example.com
                      last_name: ユーザー
                      first_name: "1"
                      birth_date: "1985-05-15"
                      phone_number: "09011111111"
                    - id: 2
                      email: user2@example.com
                      last_name: ユーザー
                      first_name: "2"
                      birth_date: "1992-08-20"
                      phone_number: "09022222222"
        '400':
          description: パラメータ不正
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                missingParameter:
                  summary: パラメータ未指定
                  value:
                    error: Missing parameter
                    message: ids, name, kana_name, phone_number のいずれかが必要です
                invalidFormat:
                  summary: フォーマット不正
                  value:
                    error: Invalid parameter format
                    message: パラメータの形式が不正です
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

    post:
      summary: ユーザー新規作成/更新
      description: |
        ユーザー情報を新規作成または更新します。

        **ID指定あり（更新）:**
        - レコード存在 → 全体更新（200 OK）
        - レコード不在 → 404 Not Found
        - updated_by にリクエスト元RPのIDを設定

        **ID指定なし（新規作成）:**
        - 常に新規作成（INSERT）
        - 成功 → 201 Created
        - email重複 → 409 Conflict（明示的エラー）
        - created_by にリクエスト元RPのIDを設定

        **user_relying_parties:**
        - metadata を user_relying_parties テーブルに保存
        - リクエスト元RPに紐づくレコードを作成/更新
      operationId: createOrUpdateUser
      tags:
        - users
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserCreateRequest'
            examples:
              createNew:
                summary: 新規作成（ID未指定）
                value:
                  email: newuser@example.com
                  password: password123
                  password_confirmation: password123
                  last_name: 佐藤
                  first_name: 桜子
                  last_kana_name: さとう
                  first_kana_name: さくらこ
                  has_middle_name: 0
                  birth_date: "1990-01-01"
                  gender_code: 1
                  phone_number: "09012345678"
                  home_prefecture_code: 13
                  home_master_city_id: 131016
                  home_address_later: 1-1-1
                  employment_status: 1
                  workplace_name: テスト株式会社
                  workplace_phone_number: "0312345678"
                  workplace_prefecture_code: 13
                  workplace_master_city_id: 131016
                  workplace_address_later: 2-2-2
                  metadata:
                    custom_id: "RP-A-001"
                    tags: ["new"]
              updateExisting:
                summary: 更新（ID指定）
                value:
                  id: 123
                  email: user@example.com
                  last_name: 佐藤
                  first_name: 桜子
                  last_kana_name: さとう
                  first_kana_name: さくらこ
                  has_middle_name: 0
                  birth_date: "1985-05-15"
                  gender_code: 2
                  phone_number: "09087654321"
                  home_prefecture_code: 13
                  home_master_city_id: 131016
                  home_address_later: 3-3-3
                  employment_status: 2
                  metadata:
                    custom_id: "RP-A-123"
                    tags: ["updated"]
      responses:
        '200':
          description: 更新成功（ID指定時）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '201':
          description: 新規作成成功（ID未指定時）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: ユーザーが存在しない（ID指定時）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                idNotFound:
                  summary: 指定IDのユーザーが存在しない
                  value:
                    error: User not found
                    message: 指定されたIDのユーザーは存在しません
        '409':
          description: email重複（ID未指定時）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                emailConflict:
                  summary: メールアドレス重複
                  value:
                    error: Email already exists
                    message: このメールアドレスは既に登録されています
        '422':
          $ref: '#/components/responses/ValidationError'

components:
  securitySchemes:
    basicAuth:
      type: http
      scheme: basic
      description: |
        Basic認証（client_id/client_secret）

        Authorization: Basic <Base64(client_id:client_secret)>

  schemas:
    User:
      type: object
      description: ユーザー情報
      required:
        - id
        - last_name
        - first_name
        - last_kana_name
        - first_kana_name
        - has_middle_name
        - employment_status
      properties:
        # 基本情報
        id:
          type: integer
          format: int64
          description: ユーザーID
          example: 123
        email:
          type: string
          format: email
          nullable: true
          description: メールアドレス
          example: user@example.com

        # 名前系
        last_name:
          type: string
          description: 姓
          example: 佐藤
        first_name:
          type: string
          description: 名
          example: 桜子
        last_kana_name:
          type: string
          description: 姓（かな）
          example: さとう
        first_kana_name:
          type: string
          description: 名（かな）
          example: さくらこ
        has_middle_name:
          type: integer
          description: ミドルネーム有無（0=なし, 1=あり）
          example: 0
        middle_name:
          type: string
          nullable: true
          description: ミドルネーム
          example: null

        # 生年月日・性別
        birth_date:
          type: string
          format: date
          nullable: true
          description: 生年月日
          example: "1990-01-01"
        gender_code:
          type: integer
          nullable: true
          description: 性別コード（1=男性, 2=女性, 3=指定しない, 4=自由記述）
          example: 1
        gender_text:
          type: string
          nullable: true
          description: 性別自由記述（gender_code=4の場合）
          example: null

        # 自宅住所
        home_is_address_selected_manually:
          type: integer
          description: 住所手動入力フラグ（0=郵便番号から自動, 1=手動選択）
          example: 0
        home_postal_code:
          type: string
          nullable: true
          description: 自宅郵便番号
          example: "1500001"
        home_prefecture_code:
          type: integer
          nullable: true
          description: 自宅都道府県コード
          example: 13
        home_master_city_id:
          type: integer
          format: int64
          nullable: true
          description: 自宅市区町村マスタID
          example: 131059
        home_address_town:
          type: string
          nullable: true
          description: 自宅町域
          example: 神宮前
        home_address_later:
          type: string
          nullable: true
          description: 自宅番地以降
          example: 1-2-3 あずかるコーポ101
        home_latitude:
          type: number
          format: double
          nullable: true
          description: 自宅緯度
          example: 35.6762
        home_longitude:
          type: number
          format: double
          nullable: true
          description: 自宅経度
          example: 139.6503

        # プロフィール画像
        profile_image_data:
          type: string
          nullable: true
          description: プロフィール画像データ（Base64等）
          example: null

        # 連絡先
        phone_number:
          type: string
          nullable: true
          description: 電話番号
          example: "09012345678"

        # 就労・勤務先
        employment_status:
          type: integer
          description: 就労状況（1=働いている, 2=働いていない, 3=答えない）
          example: 1
        workplace_name:
          type: string
          nullable: true
          description: 勤務先名
          example: あずかる株式会社
        workplace_phone_number:
          type: string
          nullable: true
          description: 勤務先電話番号
          example: "0312345678"
        workplace_is_address_selected_manually:
          type: integer
          nullable: true
          description: 勤務先住所手動入力フラグ（0=郵便番号から自動, 1=手動選択）
          example: 0
        workplace_postal_code:
          type: string
          nullable: true
          description: 勤務先郵便番号
          example: "1000001"
        workplace_prefecture_code:
          type: integer
          nullable: true
          description: 勤務先都道府県コード
          example: 13
        workplace_master_city_id:
          type: integer
          format: int64
          nullable: true
          description: 勤務先市区町村マスタID
          example: 131059
        workplace_address_town:
          type: string
          nullable: true
          description: 勤務先町域
          example: 千代田
        workplace_address_later:
          type: string
          nullable: true
          description: 勤務先番地以降
          example: 1-1-1 ビル5F

        # ログイン履歴
        last_sign_in_at:
          type: string
          format: date-time
          nullable: true
          description: 最終ログイン日時
          example: "2025-01-15T10:30:00Z"

        # タイムスタンプ
        created_at:
          type: string
          format: date-time
          description: 作成日時
          example: "2025-01-01T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          description: 更新日時
          example: "2025-01-15T12:00:00Z"

        # RP固有情報
        metadata:
          type: object
          description: RP固有のカスタム情報（リクエスト元RPに対応した情報を返却）
          additionalProperties: true
          example:
            custom_id: "RP-A-12345"
            tags: ["premium", "verified"]
            memo: "優良顧客"

    UserCreateRequest:
      type: object
      description: ユーザー作成/更新リクエスト（POST用）
      properties:
        # ID（更新時のみ）
        id:
          type: integer
          format: int64
          description: ユーザーID（指定時は更新、未指定時は新規作成）
          example: 123

        # 認証情報（新規作成時必須）
        email:
          type: string
          format: email
          description: メールアドレス
          example: user@example.com
        password:
          type: string
          description: パスワード（新規作成時必須、8文字以上）
          example: password123
        password_confirmation:
          type: string
          description: パスワード確認（新規作成時必須）
          example: password123

        # プロフィール情報（必須）
        last_name:
          type: string
          description: 姓
          example: 佐藤
        first_name:
          type: string
          description: 名
          example: 桜子
        last_kana_name:
          type: string
          description: 姓（かな、ひらがな）
          example: さとう
        first_kana_name:
          type: string
          description: 名（かな、ひらがな）
          example: さくらこ
        has_middle_name:
          type: integer
          description: ミドルネーム有無（0=なし, 1=あり）
          example: 0
        middle_name:
          type: string
          nullable: true
          description: ミドルネーム（has_middle_name=1の場合必須）
          example: null
        birth_date:
          type: string
          format: date
          description: 生年月日
          example: "1990-01-01"
        gender_code:
          type: integer
          description: 性別コード（1=男性, 2=女性, 3=指定しない, 4=自由記述）
          example: 1
        gender_text:
          type: string
          nullable: true
          description: 性別自由記述（gender_code=4の場合必須）
          example: null
        phone_number:
          type: string
          description: 電話番号
          example: "09012345678"
        home_is_address_selected_manually:
          type: integer
          description: 住所手動入力フラグ（0=郵便番号から自動, 1=手動選択）
          example: 0
        home_postal_code:
          type: string
          nullable: true
          description: 自宅郵便番号
          example: "1500001"
        home_prefecture_code:
          type: integer
          description: 自宅都道府県コード
          example: 13
        home_master_city_id:
          type: integer
          format: int64
          description: 自宅市区町村マスタID
          example: 131016
        home_address_town:
          type: string
          nullable: true
          description: 自宅町域
          example: 神宮前
        home_address_later:
          type: string
          description: 自宅番地以降
          example: 1-1-1
        employment_status:
          type: integer
          description: 就労状況（1=働いている, 2=働いていない, 3=答えない）
          example: 1
        workplace_name:
          type: string
          nullable: true
          description: 勤務先名（employment_status=1の場合必須）
          example: テスト株式会社
        workplace_phone_number:
          type: string
          nullable: true
          description: 勤務先電話番号（employment_status=1の場合必須）
          example: "0312345678"
        workplace_is_address_selected_manually:
          type: integer
          nullable: true
          description: 勤務先住所手動入力フラグ
          example: 0
        workplace_postal_code:
          type: string
          nullable: true
          description: 勤務先郵便番号
          example: "1000001"
        workplace_prefecture_code:
          type: integer
          nullable: true
          description: 勤務先都道府県コード
          example: 13
        workplace_master_city_id:
          type: integer
          format: int64
          nullable: true
          description: 勤務先市区町村マスタID
          example: 131016
        workplace_address_town:
          type: string
          nullable: true
          description: 勤務先町域
          example: 千代田
        workplace_address_later:
          type: string
          nullable: true
          description: 勤務先番地以降
          example: 2-2-2

        # RP固有情報
        metadata:
          type: object
          description: RP固有のカスタム情報
          additionalProperties: true
          example:
            custom_id: "RP-A-001"
            tags: ["new"]

    UserUpdateRequest:
      type: object
      description: ユーザー部分更新リクエスト（PATCH用、全フィールド任意）
      properties:
        # プロフィール情報（任意）
        last_name:
          type: string
          example: 佐藤
        first_name:
          type: string
          example: 桜子
        phone_number:
          type: string
          example: "09087654321"
        # ... 他のフィールドも同様に任意
        metadata:
          type: object
          description: RP固有のカスタム情報
          additionalProperties: true
          example:
            custom_id: "RP-A-999"
            tags: ["vip"]

    Error:
      type: object
      description: エラーレスポンス
      required:
        - error
      properties:
        error:
          type: string
          description: エラーの種類
          example: User not found
        message:
          type: string
          description: エラーの詳細メッセージ（オプション）
          example: 指定されたユーザーIDは存在しません

    ValidationErrorResponse:
      type: object
      description: バリデーションエラーレスポンス
      required:
        - errors
      properties:
        errors:
          type: object
          description: フィールドごとのエラーメッセージ
          additionalProperties:
            type: array
            items:
              type: string
          example:
            last_name: ["姓を入力してください"]
            phone_number: ["携帯電話を入力してください"]

  responses:
    Unauthorized:
      description: 認証失敗
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            invalidCredentials:
              summary: 認証情報が不正
              value:
                error: Invalid credentials
                message: client_id または client_secret が正しくありません
            inactiveClient:
              summary: クライアントが無効
              value:
                error: Client inactive
                message: このクライアントは無効化されています

    NotFound:
      description: ユーザーが存在しない
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            userNotFound:
              summary: ユーザーが見つからない
              value:
                error: User not found
                message: 指定されたユーザーは存在しません

    Forbidden:
      description: アクセス権限なし
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            forbidden:
              summary: アクセス権限なし
              value:
                error: Forbidden
                message: このリソースへのアクセス権限がありません

    ValidationError:
      description: バリデーションエラー
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationErrorResponse'
          examples:
            validationFailed:
              summary: バリデーション失敗
              value:
                errors:
                  last_name: ["姓を入力してください"]
                  last_kana_name: ["姓（かな）はひらがなで入力してください"]
                  phone_number: ["携帯電話を入力してください"]
