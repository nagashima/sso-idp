# 開発方針（2025-11-12更新）

## SSO版 vs Users版の開発戦略

### 決定事項
- **Users版（/users/sign_up）のみを開発・改善**
- SSO版（/sso/sign_up）は現状維持（古いまま放置）
- 機能が安定したタイミングで一括同期

### 背景・理由
- コード分析の結果、95%のHTML、90%のJavaScriptが重複
- 主な差異はAPIエンドポイント（`/users/api/` vs `/sso/api/`）とOAuth2パラメータ（`login_challenge`）のみ
- 暫定的なJavaScript+ERBの実装にコストをかけたくない（最終的にReact化予定）
- トークン消費を抑えたい（毎回2ファイル修正は非効率）
- 開発速度を優先したい

### 比較: 検討したアプローチ

| アプローチ | 初期コスト | 保守コスト | React移行 | トークン消費 | 選択 |
|---------|---------|---------|---------|------------|------|
| A: Users優先開発 | 🟢 低 | 🟡 中（最終同期1回） | 🟢 スムーズ | 🟢 最小 | ✅ **採用** |
| B: Partial共通化 | 🟡 中 | 🟢 低 | 🟡 捨てる | 🟡 中 | ❌ |
| C: Asset分離 | 🔴 高 | 🟢 低 | 🟢 活用可能 | 🟡 中 | ❌ |
| D: 両方修正 | 🟢 低 | 🔴 高 | 🟡 普通 | 🔴 高 | ❌ |

### 次期タスク優先順位

#### Phase 4: フォーム完成（Users版のみ）
1. **バリデーションロジックの肉付け**
   - フロントエンド: リアルタイムバリデーション
   - バックエンド: 詳細なエラーメッセージ、セキュリティチェック

2. **画像アップロード実装**
   - MinIOコンテナ追加（S3互換ストレージ）
   - 産後ケアRPの実装を参考
   - プロフィール画像アップロード機能

3. **その他の機能追加**
   - （必要に応じて追加）

#### Phase X: SSO版への同期（後日）

**実施タイミング:**
- バリデーション・画像アップロード等の機能が完成したとき
- React化を開始する前
- ユーザーが必要と判断したとき

**同期手順:**
```bash
# 1. Users版からSSO版にコピー
cp app/views/users/sign_up/index.html.erb \
   app/views/sso/sign_up/index.html.erb

# 2. 置換が必要な箇所（手動またはsedで）:
# - APIエンドポイント: /users/api/ → /sso/api/
# - ページタイトル: 会員登録（新API版） → SSO会員登録（新API版）
# - メッセージ: 新規会員登録 → アプリケーションからの会員登録リクエストです
# - login_challenge パラメータの追加（JavaScript）

# 3. テスト実施
# - SSO版の会員登録フロー動作確認
# - Hydra連携確認
```

### メリット
- ✅ トークン消費を最小化（1ファイルのみ修正）
- ✅ 開発速度向上（無駄な重複作業なし）
- ✅ 暫定コードへの投資を抑制
- ✅ React化への移行がスムーズ
- ✅ Users版で十分な動作確認が可能

### 注意点
- ⚠️ 一時的にSSO版とUsers版で機能差が出る
  - → ただしUsers版で動作確認できれば問題なし
- ⚠️ 最終同期を忘れないこと
  - → React化開始前に必ず実施
