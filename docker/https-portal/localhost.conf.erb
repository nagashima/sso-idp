# HTTPS設定
server {
    listen 443 ssl;
    http2 on;
    server_name localhost;

    # https-portalが自動生成する証明書を使用
    ssl_certificate <%= domain.chained_cert_path %>;
    ssl_certificate_key <%= domain.key_path %>;
    ssl_protocols TLSv1.2 TLSv1.3;

    # セキュリティヘッダー
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 共通proxy設定
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_redirect off;
    proxy_cookie_flags ~ secure;

    # 共通のlocationブロックをinclude
    include /var/lib/nginx-conf/common-locations.conf;
}
